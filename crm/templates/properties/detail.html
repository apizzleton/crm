{% extends "base.html" %}

{% block title %}{{ property.name or property.address }} - Multifamily CRM{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-12 d-flex justify-content-between align-items-center">
        <h1><i class="bi bi-building"></i> {{ property.name or property.address }}</h1>
        <div>
            <a href="{{ url_for('properties.edit', property_id=property.id) }}" class="btn btn-outline-secondary">
                <i class="bi bi-pencil"></i> Edit
            </a>
            <button type="button" class="btn btn-outline-danger" data-bs-toggle="modal" data-bs-target="#deleteModal">
                <i class="bi bi-trash"></i> Delete
            </button>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-md-8">
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0">Property Details</h5>
            </div>
            <div class="card-body">
                <dl class="row">
                    <dt class="col-sm-3">Name</dt>
                    <dd class="col-sm-9">{{ property.name or '—' }}</dd>

                    <dt class="col-sm-3">Address</dt>
                    <dd class="col-sm-9">
                        {{ property.address }}
                        {% if property.city or property.state or property.zip_code %}
                            <div class="text-muted small">
                                {% if property.city %}{{ property.city }}{% endif %}
                                {% if property.state %}{% if property.city %}, {% endif %}{{ property.state }}{% endif %}
                                {% if property.zip_code %}{% if property.city or property.state %} {% endif %}{{ property.zip_code }}{% endif %}
                            </div>
                        {% endif %}
                    </dd>

                    {% if property.units %}
                    <dt class="col-sm-3">Units</dt>
                    <dd class="col-sm-9">{{ property.units }}</dd>
                    {% endif %}

                    {% if property.property_class %}
                    <dt class="col-sm-3">Class</dt>
                    <dd class="col-sm-9">{{ property.property_class }}</dd>
                    {% endif %}

                    {% if property.year_built %}
                    <dt class="col-sm-3">Year Built</dt>
                    <dd class="col-sm-9">{{ property.year_built }}</dd>
                    {% endif %}

                    {% if property.estimated_value_min or property.estimated_value_max %}
                    <dt class="col-sm-3">Estimated Value</dt>
                    <dd class="col-sm-9">
                        {% if property.estimated_value_min and property.estimated_value_max %}
                            ${{ "{:,.0f}".format(property.estimated_value_min) }} - ${{ "{:,.0f}".format(property.estimated_value_max) }}
                        {% elif property.estimated_value_min %}
                            Min: ${{ "{:,.0f}".format(property.estimated_value_min) }}
                        {% elif property.estimated_value_max %}
                            Max: ${{ "{:,.0f}".format(property.estimated_value_max) }}
                        {% endif %}
                    </dd>
                    {% endif %}

                    {% if property.buyer_interest %}
                    <dt class="col-sm-3">Buyer Interest</dt>
                    <dd class="col-sm-9">
                        <span class="badge {% if property.buyer_interest >= 8 %}bg-success{% elif property.buyer_interest >= 5 %}bg-warning text-dark{% else %}bg-secondary{% endif %}">
                            {{ property.buyer_interest }}/10
                        </span>
                        <small class="text-muted ms-2">How much you want to buy</small>
                    </dd>
                    {% endif %}

                    {% if property.seller_motivation %}
                    <dt class="col-sm-3">Seller Motivation</dt>
                    <dd class="col-sm-9">
                        <span class="badge {% if property.seller_motivation >= 8 %}bg-success{% elif property.seller_motivation >= 5 %}bg-warning text-dark{% else %}bg-secondary{% endif %}">
                            {{ property.seller_motivation }}/10
                        </span>
                        <small class="text-muted ms-2">How much seller wants to sell</small>
                    </dd>
                    {% endif %}

                    {% if property.notes %}
                    <dt class="col-sm-3">Notes</dt>
                    <dd class="col-sm-9">{{ property.notes }}</dd>
                    {% endif %}

                    <dt class="col-sm-3">Created</dt>
                    <dd class="col-sm-9">{{ property.created_at.strftime('%B %d, %Y') }}</dd>

                    {% if property.updated_at != property.created_at %}
                    <dt class="col-sm-3">Last Updated</dt>
                    <dd class="col-sm-9">{{ property.updated_at.strftime('%B %d, %Y') }}</dd>
                    {% endif %}
                </dl>
            </div>
        </div>

        <!-- Owners Section -->
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0"><i class="bi bi-person-badge"></i> Property Owners</h5>
                <button type="button" class="btn btn-sm btn-outline-primary" data-bs-toggle="modal" data-bs-target="#addOwnerModal">
                    <i class="bi bi-plus-circle"></i> Add Owner
                </button>
            </div>
            <div class="card-body">
                {% if owners %}
                <div class="table-responsive">
                    <table class="table table-hover mb-0">
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>Company</th>
                                <th>Contact</th>
                                <th>Ownership %</th>
                                <th>Notes</th>
                                <th></th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for owner in owners %}
                            <tr>
                                <td>
                                    <a href="{{ url_for('contacts.detail', contact_id=owner.contact.id) }}">
                                        {{ owner.contact.name }}
                                    </a>
                                </td>
                                <td>{{ owner.contact.company or '—' }}</td>
                                <td>
                                    {% if owner.contact.phone %}
                                        <small><i class="bi bi-telephone"></i> {{ owner.contact.phone }}</small><br>
                                    {% endif %}
                                    {% if owner.contact.email %}
                                        <small><i class="bi bi-envelope"></i> {{ owner.contact.email }}</small>
                                    {% endif %}
                                    {% if not owner.contact.phone and not owner.contact.email %}—{% endif %}
                                </td>
                                <td>{{ owner.ownership_percentage|default('—', true) }}{% if owner.ownership_percentage %}%{% endif %}</td>
                                <td>{{ owner.notes or '—' }}</td>
                                <td>
                                    <form method="POST" action="{{ url_for('properties.remove_owner', property_id=property.id, owner_id=owner.id) }}" 
                                          style="display: inline;" onsubmit="return confirm('Remove this owner?');">
                                        <button type="submit" class="btn btn-sm btn-outline-danger">
                                            <i class="bi bi-x-circle"></i>
                                        </button>
                                    </form>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <p class="text-muted mb-0">No owners tagged to this property yet.</p>
                {% endif %}
            </div>
        </div>
    </div>


</div>

<!-- Add Owner Modal -->
<div class="modal fade" id="addOwnerModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <form method="POST" action="{{ url_for('properties.add_owner', property_id=property.id) }}">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="bi bi-person-plus"></i> Add Property Owner</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="contact_id" class="form-label">Select Contact *</label>
                        <select class="form-select" id="contact_id" name="contact_id" required>
                            <option value="">Choose a contact...</option>
                            {% for contact in all_contacts %}
                                <option value="{{ contact.id }}">
                                    {{ contact.name }}{% if contact.company %} ({{ contact.company }}){% endif %}
                                </option>
                            {% endfor %}
                        </select>
                        <div class="form-text">
                            <a href="{{ url_for('contacts.create') }}">Create new contact</a> if not in list.
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="ownership_percentage" class="form-label">Ownership Percentage</label>
                        <div class="input-group">
                            <input type="number" class="form-control" id="ownership_percentage" name="ownership_percentage"
                                   min="0" max="100" step="0.01" placeholder="e.g., 50">
                            <span class="input-group-text">%</span>
                        </div>
                        <div class="form-text">Optional - leave blank if unknown.</div>
                    </div>
                    <div class="mb-3">
                        <label for="owner_notes" class="form-label">Notes</label>
                        <textarea class="form-control" id="owner_notes" name="notes" rows="2" 
                                  placeholder="e.g., Primary decision maker"></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">
                        <i class="bi bi-plus-circle"></i> Add Owner
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal fade" id="deleteModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Delete Property</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to delete this property?</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <form method="POST" action="{{ url_for('properties.delete', property_id=property.id) }}" style="display: inline;">
                    <button type="submit" class="btn btn-danger">Delete Property</button>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}
